<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UrlController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">url-shortener</a> &gt; <a href="index.source.html" class="el_package">com.shortscale.controller</a> &gt; <span class="el_source">UrlController.java</span></div><h1>UrlController.java</h1><pre class="source lang-java linenums">package com.shortscale.controller;

import com.google.zxing.BarcodeFormat;
import com.google.zxing.WriterException;
import com.google.zxing.client.j2se.MatrixToImageWriter;
import com.google.zxing.common.BitMatrix;
import com.google.zxing.qrcode.QRCodeWriter;
import com.shortscale.api.dto.BulkShortenRequest;
import com.shortscale.api.dto.BulkShortenResponse;
import com.shortscale.api.dto.ShortenRequest;
import com.shortscale.api.dto.ShortenResponse;
import com.shortscale.service.UrlService;
import com.shortscale.util.RateLimiter;
import jakarta.servlet.http.HttpServletRequest;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.io.ByteArrayOutputStream;
import java.io.IOException;

@RestController
@RequestMapping(&quot;/api&quot;)
public class UrlController {

    private final UrlService urlService;
    private final RateLimiter rateLimiter;

<span class="fc" id="L30">    public UrlController(UrlService urlService, RateLimiter rateLimiter) {</span>
<span class="fc" id="L31">        this.urlService = urlService;</span>
<span class="fc" id="L32">        this.rateLimiter = rateLimiter;</span>
<span class="fc" id="L33">    }</span>

    @PostMapping(&quot;/shorten&quot;)
    public ResponseEntity&lt;ShortenResponse&gt; shortenUrl(@RequestBody ShortenRequest request, HttpServletRequest httpRequest) {
<span class="fc" id="L37">        String clientIp = httpRequest.getRemoteAddr();</span>
<span class="fc bfc" id="L38" title="All 2 branches covered.">        if (!rateLimiter.isAllowed(clientIp)) {</span>
<span class="fc" id="L39">            return ResponseEntity.status(HttpStatus.TOO_MANY_REQUESTS).build();</span>
        }
        try {
<span class="fc" id="L42">            ShortenResponse response = urlService.shortenUrl(request);</span>
<span class="fc" id="L43">            return ResponseEntity.ok(response);</span>
<span class="fc" id="L44">        } catch (IllegalArgumentException e) {</span>
<span class="fc" id="L45">            return ResponseEntity.badRequest().build();</span>
        }
    }

    @PostMapping(&quot;/shorten/bulk&quot;)
    public ResponseEntity&lt;BulkShortenResponse&gt; bulkShortenUrls(@RequestBody BulkShortenRequest request, HttpServletRequest httpRequest) {
<span class="fc" id="L51">        String clientIp = httpRequest.getRemoteAddr();</span>
<span class="pc bpc" id="L52" title="1 of 2 branches missed.">        if (!rateLimiter.isAllowed(clientIp)) {</span>
<span class="nc" id="L53">            return ResponseEntity.status(HttpStatus.TOO_MANY_REQUESTS).build();</span>
        }
        try {
<span class="fc" id="L56">            BulkShortenResponse response = urlService.bulkShortenUrls(request);</span>
<span class="fc" id="L57">            return ResponseEntity.ok(response);</span>
<span class="nc" id="L58">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L59">            return ResponseEntity.badRequest().build();</span>
        }
    }

    @GetMapping(&quot;/analytics/{shortCode}&quot;)
    public ResponseEntity&lt;Integer&gt; getAnalytics(@PathVariable String shortCode) {
<span class="fc" id="L65">        int clickCount = urlService.getClickCount(shortCode);</span>
<span class="fc" id="L66">        return ResponseEntity.ok(clickCount);</span>
    }

    @GetMapping(value = &quot;/qr/{shortCode}&quot;, produces = MediaType.IMAGE_PNG_VALUE)
    public ResponseEntity&lt;byte[]&gt; getQRCode(@PathVariable String shortCode) {
        try {
<span class="fc" id="L72">            String url = &quot;http://localhost:8080/&quot; + shortCode; // Adjust the URL as needed</span>
<span class="fc" id="L73">            QRCodeWriter qrCodeWriter = new QRCodeWriter();</span>
<span class="fc" id="L74">            BitMatrix bitMatrix = qrCodeWriter.encode(url, BarcodeFormat.QR_CODE, 200, 200);</span>

<span class="fc" id="L76">            ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();</span>
<span class="fc" id="L77">            MatrixToImageWriter.writeToStream(bitMatrix, &quot;PNG&quot;, byteArrayOutputStream);</span>
<span class="fc" id="L78">            byte[] qrCodeImage = byteArrayOutputStream.toByteArray();</span>

<span class="fc" id="L80">            return ResponseEntity.ok(qrCodeImage);</span>
<span class="nc" id="L81">        } catch (WriterException | IOException e) {</span>
<span class="nc" id="L82">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>